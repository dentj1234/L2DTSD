<!DOCTYPE html>
<html>
<head>
    <title>Your Cart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='main.js') }}"></script>
</head>
<body>
    <nav>
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('menu') }}">Menu</a>
        <a href="{{ url_for('cart') }}">Cart</a>
    </nav>

    <div class="cart-container">
        <h1>Your Cart:</h1>
        {% if items %}
            {% for item in items %}
                <div class="item-card" data-item-id="{{ item[0] }}" data-price="{{ item[3] }}">
                    <div class="item-info">
                        <h2>{{ item[2] }}</h2>
                        <p>Price: ${{ item[3] }}</p>
                    </div>
                    <div class="item-description">
                        <p>{{ item[5] }}</p>  <!-- Assuming your description is at index 5 -->
                    </div>
                    <div>
                        <p>Quantity:</p> 
                    </div>
                    <div class="quantity-control" data-item-id="{{ item[0] }}">
                        <p class="qty-display">{{ counts[item[0]] }}</p>
                        <div class="item-quantity-buttons">
                            <button class="increase-btn">+</button>
                            <button class="decrease-btn">−</button>
                        </div>
                    </div>
                    <div class="remove-item" data-item-id="{{ item[0] }}">
                        <button class="remove-item-btn" >Remove Item</button>
                    </div>
                    <img src="{{ url_for('static', filename='' ~ item[2] ~ '.png') }}" alt="{{ item[2] }}">
                </div>
            {% endfor %}
        {% else %}
            <p>Your cart is empty.</p>
        {% endif %}
        
        <a href="{{ url_for('menu') }}" class="back-link">← Back to Menu</a>
        
        <button id="clear-cart-btn" >Clear Cart</button>
        
        <div class="cart-total">
            <h2>Total: $<span id="total-cost">{{ "%.2f"|format(total) }}</span></h2>
        </div>
        
        <script>
            document.getElementById('clear-cart-btn').onclick = function() {
                fetch("/clear_cart", {
                    method: "POST"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    }
                });
          };


        //Increase Button
        document.querySelectorAll('.increase-btn').forEach(button => {
            button.onclick = function () {
              
                // Find item ID from closest quantity control div. 
                const control = this.closest('.quantity-control');
                const itemId = control.dataset.itemId;
                const display = control.querySelector('.qty-display');
        
                // Increase quantity by 1
                const newQty = parseInt(display.textContent) + 1;
                
                display.textContent = newQty;
                recalcTotal();
            
                // update the cart
                fetch('/update_cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId, quantity: newQty })
                });
            };
        });

        //Decrease Button
        document.querySelectorAll('.decrease-btn').forEach(button => {
            button.onclick = function () {

                // Find item ID from closest quantity control div.
                const control = this.closest('.quantity-control');
                const itemId = control.dataset.itemId;
                const display = control.querySelector('.qty-display');
        
                // Decrease quantity by 1, ensuring it doesn't go below 1
                const newQty = Math.max(1, parseInt(display.textContent) - 1);
                
                display.textContent = newQty;
                recalcTotal();

                // update the cart
                fetch('/update_cart', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({ item_id: itemId, quantity: newQty })
                });
            };
        });


        //Remove Item Button
        document.querySelectorAll('.remove-item-btn').forEach(button => {
            button.onclick = function () {
                const control = this.closest('.remove-item');
                const itemId = control.dataset.itemId;

                // Update and remove the item from the cart
                fetch('/update_cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId, quantity: 0 })
                })
                // update the UI
                .then(() => {
                    const itemCard = this.closest('.item-card');
                    if (itemCard) {
                        itemCard.remove();
                    }
                    recalcTotal();
                });
                
            };
        });
        </script>
    </div>
</body>
</html>
